<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ù„Ø±Ø§ÙƒØ¨ - ØªÙƒØ³ÙŠ Ø§Ù„Ø¹Ø±Ø§Ù‚ Ø§Ù„Ø´Ø§Ù…Ù„</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
<style>
body,html{margin:0;padding:0;height:100%;font-family:Tahoma;}
#map{height:80vh;}
#panel{background:#fff;text-align:center;padding:10px;box-shadow:0 -2px 5px rgba(0,0,0,0.2);}
button{background:#ffca28;border:none;padding:10px 20px;border-radius:8px;font-weight:bold;cursor:pointer;margin:5px;}
#callDriver{background:#4caf50;color:#fff;display:none;}
#logout{background:#9e9e9e;color:#fff;}
</style>
</head>
<body>
<div id="map"></div>
<div id="panel">
  <h3>ğŸš– Ø·Ù„Ø¨ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
  <p id="status">ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø§Ù„Ø¢Ù†...</p>
  <button id="sendRide" disabled>Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
  <button id="callDriver">ğŸ“ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³Ø§Ø¦Ù‚</button>
  <button id="logout">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
</div>

<script>
const app=firebase.initializeApp({
  apiKey:"AIzaSyBZy7GTKn62CqeXAgm2fLrXI67P4Lc4Q3M",
  authDomain:"taxi-15314.firebaseapp.com",
  databaseURL:"https://taxi-15314-default-rtdb.firebaseio.com/",
  projectId:"taxi-15314"
});
const db=firebase.database();

let map=L.map('map').setView([33.3152,44.3661],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

let startCoords=null,endCoords=null;
let startMarker=null,endMarker=null;
let driverMarker=null;
let rideId=null;
let driverPhone=null;

// ğŸ”Š ØµÙˆØª Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡
function playBeep(){
  const ctx=new (window.AudioContext||window.webkitAudioContext)();
  const osc=ctx.createOscillator();const gain=ctx.createGain();
  osc.type="sine";osc.frequency.value=800;
  osc.connect(gain);gain.connect(ctx.destination);
  osc.start();setTimeout(()=>osc.stop(),300);
}

// ğŸ“ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø±Ø§ÙƒØ¨
navigator.geolocation.getCurrentPosition(pos=>{
  startCoords=[pos.coords.latitude,pos.coords.longitude];
  startMarker=L.marker(startCoords).addTo(map).bindPopup("ğŸ“ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ").openPopup();
  map.setView(startCoords,15);
  document.getElementById("status").innerText="Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ©.";
},err=>{
  document.getElementById("status").innerText="âš ï¸ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§ÙŠØ© ÙÙ‚Ø·.";
});

// ğŸ—ºï¸ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
map.on('click',function(e){
  if(endMarker){map.removeLayer(endMarker);}
  endCoords=[e.latlng.lat,e.latlng.lng];
  endMarker=L.marker(endCoords).addTo(map).bindPopup("ğŸ Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ©").openPopup();
  document.getElementById("status").innerText="ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨.";
  document.getElementById("sendRide").disabled=false;
});

// ğŸš– Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
document.getElementById("sendRide").onclick=function(){
  if(!startCoords||!endCoords){alert("âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©.");return;}
  const phone=localStorage.getItem('phone')||"ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
  const R=6371;
  const dLat=(endCoords[0]-startCoords[0])*Math.PI/180;
  const dLon=(endCoords[1]-startCoords[1])*Math.PI/180;
  const a=Math.sin(dLat/2)**2+Math.cos(startCoords[0]*Math.PI/180)*Math.cos(endCoords[0]*Math.PI/180)*Math.sin(dLon/2)**2;
  const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  const distance=(R*c).toFixed(2);
  const fare=Math.round(distance*1000);
  rideId=Date.now();
  db.ref("rides/"+rideId).set({
    riderPhone:phone,
    start:startCoords,
    end:endCoords,
    distance,
    fare,
    status:"Ø¬Ø¯ÙŠØ¯Ø©"
  }).then(()=>{
    document.getElementById("status").innerHTML=`âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨<br>Ø§Ù„Ù…Ø³Ø§ÙØ©: ${distance} ÙƒÙ… â€” Ø§Ù„Ø£Ø¬Ø±Ø©: ${fare} Ø¯.Ø¹<br>Ø¨Ø¥Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø³Ø§Ø¦Ù‚...`;
    findNearestDriver(startCoords);
  });
};

// ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£Ù‚Ø±Ø¨ Ø³Ø§Ø¦Ù‚
function findNearestDriver(coords){
  db.ref("drivers").once("value").then(snap=>{
    let minDist=999999,nearestPhone=null;
    snap.forEach(d=>{
      const data=d.val();if(!data.location)return;
      const lat=data.location.lat,lng=data.location.lng;
      const dist=Math.sqrt((lat-coords[0])**2+(lng-coords[1])**2);
      if(dist<minDist){minDist=dist;nearestPhone=d.key;}
    });
    if(nearestPhone){
      db.ref("rides/"+rideId+"/assignedDriver").set(nearestPhone);
      // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ø³Ø§Ø¦Ù‚
      db.ref("drivers/"+nearestPhone+"/notification").set({
        message:"ğŸš– Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø±Ø§ÙƒØ¨ Ø¨Ø§Ù„Ù‚Ø±Ø¨ Ù…Ù†Ùƒ",
        rideId:rideId,
        time:new Date().toISOString()
      });
    }
  });
}

// ğŸŸ¢ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
function listenForUpdates(){
  if(!rideId)return;
  db.ref("rides/"+rideId).on("value",snapshot=>{
    const ride=snapshot.val();if(!ride)return;
    if(ride.status==="Ù…Ù‚Ø¨ÙˆÙ„Ø©"){
      playBeep();
      driverPhone=ride.driverPhone;
      document.getElementById("status").innerHTML=`ğŸš• Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚ Ø¥Ù„ÙŠÙƒ...<br>Ø§Ù„Ù…Ø³Ø§ÙØ©: ${ride.distance} ÙƒÙ…<br>Ø§Ù„Ø£Ø¬Ø±Ø©: ${ride.fare} Ø¯.Ø¹`;
      document.getElementById("callDriver").style.display="inline-block";
      watchDriver(driverPhone);
    }
    if(ride.status==="Ù…Ù†ØªÙ‡ÙŠØ©"){
      playBeep();
      document.getElementById("status").innerHTML="ğŸš— ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© â€” Ø´ÙƒØ±Ù‹Ø§ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ùƒ ØªÙƒØ³ÙŠ Ø§Ù„Ø¹Ø±Ø§Ù‚ Ø§Ù„Ø´Ø§Ù…Ù„";
      if(driverMarker) map.removeLayer(driverMarker);
      document.getElementById("callDriver").style.display="none";
    }
  });
}
listenForUpdates();

// â˜ï¸ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³Ø§Ø¦Ù‚
document.getElementById("callDriver").onclick=function(){
  if(driverPhone) window.location.href="tel:"+driverPhone;
  else alert("ğŸš« Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ø³Ø§Ø¦Ù‚ Ø¨Ø¹Ø¯.");
};

// ğŸ‘€ ØªØªØ¨Ø¹ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚
function watchDriver(phone){
  db.ref("drivers/"+phone+"/location").on("value",snap=>{
    const loc=snap.val();if(!loc)return;
    const coords=[loc.lat,loc.lng];
    const carIcon=L.icon({iconUrl:"https://cdn-icons-png.flaticon.com/512/744/744465.png",iconSize:[40,40],iconAnchor:[20,20]});
    if(!driverMarker) driverMarker=L.marker(coords,{icon:carIcon}).addTo(map).bindPopup("ğŸš– Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚");
    else driverMarker.setLatLng(coords);
  });
}

// ğŸ”š Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬
window.onbeforeunload=function(){
  if(rideId) db.ref("rides/"+rideId).update({status:"Ù…Ù†ØªÙ‡ÙŠØ©",notification:"ğŸš• Ø§Ù„Ø±Ø§ÙƒØ¨ Ø£Ù†Ù‡Ù‰ Ø§Ù„Ø±Ø­Ù„Ø©"});
};

// ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
document.getElementById("logout").onclick=()=>{
  if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")){
    localStorage.clear();
    window.location.href="index.html";
  }
};
</script>
</body>
</html>
