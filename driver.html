<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ù„Ø³Ø§Ø¦Ù‚ - ØªÙƒØ³ÙŠ Ø§Ù„Ø¹Ø±Ø§Ù‚ Ø§Ù„Ø´Ø§Ù…Ù„</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
<style>
html,body{margin:0;padding:0;height:100%;font-family:Tahoma;background:#f5f5f5;}
#map{height:80vh;width:100%;}
#panel{background:#fff;text-align:center;padding:10px;box-shadow:0 -2px 5px rgba(0,0,0,0.2);}
h3{color:#2e7d32;margin:5px 0;}
button{background:#fdd835;border:none;padding:12px 24px;border-radius:10px;font-weight:bold;cursor:pointer;margin:6px;font-size:16px;}
button:hover{background:#ffee58;}
#endRide{background:#4caf50;color:#fff;}
#logout{background:#9e9e9e;color:#fff;}
</style>
</head>
<body>
<div id="map"></div>
<div id="panel">
  <h3>ğŸš– Ù„ÙˆØ­Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚</h3>
  <div id="rideInfo">ğŸ“ Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ...</div>
  <button id="endRide" disabled>ğŸš— Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©</button>
  <button id="logout">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
</div>

<script>
const app=firebase.initializeApp({
  apiKey:"AIzaSyBZy7GTKn62CqeXAgm2fLrXI67P4Lc4Q3M",
  authDomain:"taxi-15314.firebaseapp.com",
  databaseURL:"https://taxi-15314-default-rtdb.firebaseio.com/",
  projectId:"taxi-15314"
});
const db=firebase.database();

const phone=localStorage.getItem("phone")||"ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
const driverRef=db.ref("drivers/"+phone);

// ğŸ”Š ØªÙ†Ø¨ÙŠÙ‡ ØµÙˆØªÙŠ
let audioCtx=null,beepInterval=null;
function startBeep(){
  if(audioCtx==null) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  stopBeep();
  beepInterval=setInterval(()=>{
    const osc=audioCtx.createOscillator();
    const gain=audioCtx.createGain();
    osc.type="sine"; osc.frequency.value=700;
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.start(); setTimeout(()=>osc.stop(),300);
  },1000);
  setTimeout(stopBeep,15000);
}
function stopBeep(){if(beepInterval){clearInterval(beepInterval);beepInterval=null;}}

// ğŸ—ºï¸ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
let map=L.map('map').setView([33.3152,44.3661],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
let driverMarker=null;
let currentCoords=[33.3152,44.3661];
let currentRideId=null;
let routeControl=null;

// ğŸ“ ØªØ­Ø¯ÙŠØ« Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
function updateDriverLocation(){
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      currentCoords=[pos.coords.latitude,pos.coords.longitude];
      if(!driverMarker){
        const icon=L.icon({iconUrl:"https://cdn-icons-png.flaticon.com/512/744/744465.png",iconSize:[40,40],iconAnchor:[20,20]});
        driverMarker=L.marker(currentCoords,{icon}).addTo(map).bindPopup("ğŸš– Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ");
      } else driverMarker.setLatLng(currentCoords);
      driverRef.child("location").set({lat:currentCoords[0],lng:currentCoords[1]});
    });
  }
}
setInterval(updateDriverLocation,3000);
updateDriverLocation();

// ğŸŸ¢ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø© Ù„Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙ‚Ø·
db.ref("rides").on("child_added",snap=>{
  const ride=snap.val(),id=snap.key;
  if(ride.assignedDriver!==phone || ride.status!=="Ø¬Ø¯ÙŠØ¯Ø©")return;
  startBeep();
  document.getElementById("rideInfo").innerHTML=
    `ğŸ“ Ø±Ø§ÙƒØ¨ Ø¬Ø¯ÙŠØ¯<br>Ù…Ù† (${ride.start[0].toFixed(4)}, ${ride.start[1].toFixed(4)})<br>Ø¥Ù„Ù‰ (${ride.end[0].toFixed(4)}, ${ride.end[1].toFixed(4)})<br>
    Ø§Ù„Ù…Ø³Ø§ÙØ©: ${ride.distance} ÙƒÙ…<br>Ø§Ù„Ø£Ø¬Ø±Ø©: ${ride.fare} Ø¯.Ø¹<br><br>
    <button id="accept">âœ… Ù‚Ø¨ÙˆÙ„</button> <button id="reject">âŒ Ø±ÙØ¶</button>`;

  document.getElementById("accept").onclick=()=>{
    stopBeep();
    currentRideId=id;
    db.ref("rides/"+id).update({
      status:"Ù…Ù‚Ø¨ÙˆÙ„Ø©",
      driverPhone:phone,
      notification:"âœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø© Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø³Ø§Ø¦Ù‚"
    });
    showRouteToRider(ride);
  };

  document.getElementById("reject").onclick=()=>{
    stopBeep();
    db.ref("rides/"+id).update({status:"Ù…Ø±ÙÙˆØ¶Ø©",notification:"âŒ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø±ÙØ¶ Ø§Ù„Ø±Ø­Ù„Ø©"});
    document.getElementById("rideInfo").innerText="ğŸš• ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø±Ø­Ù„Ø© â€” Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯.";
  };
});

// ğŸš— Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³Ø§Ø± Ø¥Ù„Ù‰ Ø§Ù„Ø±Ø§ÙƒØ¨ Ø£ÙˆÙ„Ù‹Ø§ Ø«Ù… Ø§Ù„ÙˆØ¬Ù‡Ø©
function showRouteToRider(ride){
  if(routeControl){map.removeControl(routeControl);}
  const start=L.latLng(currentCoords[0],currentCoords[1]);
  const rider=L.latLng(ride.start[0],ride.start[1]);
  routeControl=L.Routing.control({
    waypoints:[start,rider],
    lineOptions:{styles:[{color:'blue',opacity:0.7,weight:5}]},
    addWaypoints:false,fitSelectedRoutes:true,show:false
  }).addTo(map);
  document.getElementById("rideInfo").innerText="ğŸš• Ù…ØªØ¬Ù‡ Ø¥Ù„Ù‰ Ø§Ù„Ø±Ø§ÙƒØ¨...";
  checkArrivalToRider(ride);
}

// ğŸ‘€ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø±Ø§ÙƒØ¨
function checkArrivalToRider(ride){
  const interval=setInterval(()=>{
    const dx=currentCoords[0]-ride.start[0];
    const dy=currentCoords[1]-ride.start[1];
    const dist=Math.sqrt(dx*dx+dy*dy)*111000;
    if(dist<100){ // 100 Ù…ØªØ±
      clearInterval(interval);
      document.getElementById("rideInfo").innerText="âœ… ÙˆØµÙ„Øª Ø¥Ù„Ù‰ Ø§Ù„Ø±Ø§ÙƒØ¨ØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØ¬Ù‡ Ø¥Ù„Ù‰ Ø§Ù„ÙˆØ¬Ù‡Ø©...";
      showRouteToDestination(ride);
    }
  },5000);
}

// ğŸ¯ Ø§Ù„Ù…Ø³Ø§Ø± Ø¥Ù„Ù‰ Ø§Ù„ÙˆØ¬Ù‡Ø©
function showRouteToDestination(ride){
  if(routeControl){map.removeControl(routeControl);}
  routeControl=L.Routing.control({
    waypoints:[L.latLng(ride.start[0],ride.start[1]),L.latLng(ride.end[0],ride.end[1])],
    lineOptions:{styles:[{color:'green',opacity:0.8,weight:5}]},
    addWaypoints:false,fitSelectedRoutes:true,show:false
  }).addTo(map);
  document.getElementById("rideInfo").innerText="ğŸš— ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚ Ø¥Ù„Ù‰ ÙˆØ¬Ù‡Ø© Ø§Ù„Ø±Ø§ÙƒØ¨...";
  document.getElementById("endRide").disabled=false;
}

// ğŸ›‘ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©
document.getElementById("endRide").onclick=()=>{
  if(!currentRideId)return;
  db.ref("rides/"+currentRideId).update({
    status:"Ù…Ù†ØªÙ‡ÙŠØ©",
    notification:"ğŸš— ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø³Ø§Ø¦Ù‚"
  });
  if(routeControl){map.removeControl(routeControl);}
  document.getElementById("rideInfo").innerText="ğŸš— ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©. Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯...";
  document.getElementById("endRide").disabled=true;
};

// ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
document.getElementById("logout").onclick=()=>{
  if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")){
    localStorage.clear();
    window.location.href="index.html";
  }
};
</script>
</body>
</html>
